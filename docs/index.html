<!DOCTYPE html>
<meta charset='utf-8'>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<html>

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-144588008-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-144588008-1');
    </script>

    <title>駅メモ属性マップ</title>
    <script src="d3.v5.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>

    <style>
        body {
            padding: 0;
            margin: 0
        }

        html,
        body,
        #map {
            height: 100%;
            width: 100%;
        }

        #eem-toolbox {
            z-index: 10000;
            position: fixed;
            top: 12px;
            right: 12px;
        }

        .eem-tool-button {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            margin-top: 4px;
            border: solid 2px;
            border-color: rgba(100, 100, 100, 0.6);
        }

        .eem-tool-button-inner {
            width: 30px;
            height: 30px;
            margin: 3px;
        }

        .gps-button {
            fill: rgb(21, 126, 250);
        }
    </style>

</head>

<body>
    <div id="map">
        <div id="eem-toolbox">
            <div class="eem-tool-button" onClick="goToGpsLocation()">
                <svg class="eem-tool-button-inner gps-button" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                    viewBox="0 0 24 24">
                    <path fill="none" d="M0 0h24v24H0V0z" />
                    <path
                        d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z" />
                </svg>
            </div>

        </div>
    </div>

    <script>
        var map = L.map('map');
        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
            attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
        }).addTo(map);

        map.setView([35.681633, 139.767207], 15); // 東京駅
        try {
            var saved = JSON.parse(localStorage.getItem("last_location"));
            map.setView([saved.latitude, saved.longitude], saved.zoom);
        } catch (e) {
            console.log(e);
        }

        var svgLayer = d3.select(map.getPanes().overlayPane)
            .append('svg')
            .attr('class', 'leaflet-zoom-hide');
        var plotLayer = svgLayer.append('g');

        var voronoi = d3.voronoi()
            .x(function (d) {
                return d.latitude;
            })
            .y(function (d) {
                return d.longitude;
            }).extent([[26.053896, 127.594806], [45.681028, 145.890560]]);

        var updatePosition = function (d) {
            d.pos = map.latLngToLayerPoint(new L.LatLng(d.latitude, d.longitude));
            d3.select(this)
                .attr("cx", d.pos.x)
                .attr("cy", d.pos.y);
        }

        var updatePathPosition = function (d) {
            d3.select(this)
                .attr('fill', function (pathd) {
                    if (!pathd) return null;
                    switch (pathd.data.element) {
                        case 'cool':
                            return 'blue';
                            break;
                        case 'heat':
                            return 'red';
                            break;
                        case 'eco':
                            return 'green';
                            break;
                        default:
                            return 'gray';
                            break;
                    }
                })
                .attr("d", function (pathd) {
                    if (!pathd) return null;
                    const newpathd = pathd.map(latlng => {
                        const newpos = map.latLngToLayerPoint(new L.LatLng(latlng[0], latlng[1]));
                        return [newpos.x, newpos.y];
                    });
                    const ret = "M" + newpathd.join("L") + "Z";
                    return ret;
                });
        }

        const station_file = 'stations.json';

        d3.json(station_file).then(
            function (data) {
                // console.log(data);
                var points = data.stations;
                var polygons = voronoi(points).polygons();

                // console.log(polygons);
                plotLayer
                    .selectAll(".cell")
                    .data(polygons)
                    .enter()
                    .append("svg:path")
                    .attr('stroke', "black")
                    .attr('fill-opacity', 0.1)
                    .each(updatePathPosition);

                plotLayer
                    .selectAll('circle')
                    .data(points)
                    .enter()
                    .append('circle')
                    .attr('r', 3)
                    .attr('fill', "blue")
                    .attr('stroke', "white")
                    .attr('stroke-width', 1)
                    .each(updatePosition);

                map.on('zoomend', function () {
                    plotLayer
                        .selectAll('circle')
                        .each(updatePosition);
                    plotLayer
                        .selectAll('path')
                        .each(updatePathPosition);
                });

                map.on('moveend', function (e) {
                    try {
                        const center = e.target.getCenter();
                        var last_location = {
                            latitude: center.lat,
                            longitude: center.lng,
                            zoom: e.target.getZoom()
                        };
                        localStorage.setItem("last_location", JSON.stringify(last_location));
                    } catch (e) {
                        console.log(e);
                    }
                });

                reset();
            });

        var reset = function () {
            var bounds = map.getBounds();
            var topLeft = map.latLngToLayerPoint(bounds.getNorthWest());
            var bottomRight = map.latLngToLayerPoint(bounds.getSouthEast());

            svgLayer
                .attr("width", bottomRight.x - topLeft.x)
                .attr("height", bottomRight.y - topLeft.y)
                .style("left", topLeft.x + "px")
                .style("top", topLeft.y + "px");

            plotLayer
                .attr('transform', 'translate(' + -topLeft.x + ',' + -topLeft.y + ')');
        }

        map.on("move", reset);

        function goToGpsLocation() {
            navigator.geolocation.getCurrentPosition(function (pos) {
                try {
                    map.setView([pos.coords.latitude, pos.coords.longitude], 14);
                } catch (e) {
                    console.log(e);
                }
            });
        }
    </script>
</body>

</html>